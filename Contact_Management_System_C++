#include <stdio.h>	// 기본 
#include <string.h>	// 글자처리 
#include <process.h> // system("cls")
#include <stdlib.h> // 파일 
#include <conio.h> 
#include <dos.h>
struct Contact{
	long digits;
	char name[20], address[20], email[25];
} list;

char query[20],name[20];
FILE *fp, *ft;
int mode,i,n,l,found;

void add();

void search();
void edit();
void del();
int main(void){
	// 초기화면설정
main:
	system("cls");    /* ************Main menu ***********************  */
    printf("\n\t **** Welcome to Contact Management System ****");
    printf("\n\n\n\t\t\tMAIN MENU\n\t\t=====================\n\t\t[1] Add a new Contact\n\t\t[2] List all Contacts\n\t\t[3] Search for contact\n\t\t[4] Edit a Contact\n\t\t[5] Delete a Contact\n\t\t[0] Exit\n\t\t=====================\n\t\t");
    printf("Enter the choice:"); 
	scanf("%d", &mode);
	
	switch(mode){
		case 0:
			printf("\n\n\t\tAre you sure you want to exit?");
			break;
			
		case 1:
			add();
			break;
			
		case 2:
			
			break;
			
		case 3:
			search();
			break;
			
		case 4:
			edit();
			break;
			
		case 5:
			
			break;	
	}
	printf("\n\t\t[1] Main Menu\t[0] Exit\n");
	printf("\t\tEnter the choice : ");
	scanf("%d", &mode);
	if(mode == 0)
		return 0;
    else if(mode == 1)
        goto main;	
}

// 연락처추가 
void add(){	
	system("cls");
        fp=fopen("contact.dll","a");

        for (;;) { 
            fflush(stdin);
            printf("To exit enter blank space in the name input\nName (Use identical):");
            scanf("%[^\n]",&list.name);

            if(stricmp(list.name,"")==0 || stricmp(list.name," ")==0)
                break;
                
            fflush(stdin);
            printf("Phone:");
            scanf("%ld",&list.digits);
            fflush(stdin);
            printf("address:");
            scanf("%[^\n]",&list.address);
            fflush(stdin);
            printf("email address:");
            gets(list.email);
            printf("\n");
            fwrite(&list,sizeof(list),1,fp);
        }
        fclose(fp);
}

// 연락처검색 
void search(){
	system("cls");
	do{
		found = 0;
		printf("\n\n\t..::CONTACT SEARCH\n\t===========================\n\t..::Name of contact to search: ");
		fflush(stdin);
		scanf("%[^\n]",&query);
		l = strlen(query);
		fp = fopen("contact.dll", "r");
		system("cls");
		printf("\n\n..::Search result for '%s' \n===================================================\n",query);
		
		while(fread(&list, sizeof(list), 1, fp)==1){
			for(i = 0; i <= l; i++)
				name[i] = list.name[i];
			if(strcmp(name, query) == 0){
				printf("\n..::Name\t: %s\n..::Phone\t: %ld\n..::Address\t: %s\n..::Email\t: %s\n",list.name,list.digits,list.address,list.email);
                found++;
                
                if(found % 4 == 0){
					printf("..::Press any key to continue...");
                    getch();
				}
			}
			
			if(found==0)
                printf("\n..::No match found!");
            else
                printf("\n..::%d match(s) found!",found);
            fclose(fp);
            printf("\n ..::Try again?\n\n\t[1] Yes\t\t[0] No\n\t");
            scanf("%d",&mode);
		}
	}while(mode == 1);
} 

// 연락처편집
void edit(){
	system("cls");
    fp=fopen("contact.dll","r");
    ft=fopen("temp.dat","w");
    fflush(stdin);
    printf("..::Edit contact\n===============================\n\n\t..::Enter the name of contact to edit:");
    scanf("%[^\n]",name);

    while(fread(&list,sizeof(list),1,fp)==1){
        if(stricmp(name,list.name)!=0)
            fwrite(&list,sizeof(list),1,ft);
    }

    fflush(stdin);
    printf("\n\n..::Editing '%s'\n\n",name);
    printf("..::Name(Use identical):");
    scanf("%[^\n]",&list.name);
    fflush(stdin);
    printf("..::Phone:");
    scanf("%ld",&list.digits);
    fflush(stdin);
    printf("..::address:");
    scanf("%[^\n]",&list.address);
    fflush(stdin);
    printf("..::email address:");
    gets(list.email);
    printf("\n");
    fwrite(&list,sizeof(list),1,ft);
    fclose(fp);
    fclose(ft);
    remove("contact.dll");
    rename("temp.dat","contact.dll");
} 
